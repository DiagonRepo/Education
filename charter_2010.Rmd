---
title: "Longitudinal study of factors influencing student academic performance in CA schools"
author: "STAT 420, Summer 2018, bching3, cindyst2, rjs8, trapido2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r eval=FALSE}
install.packages("foreign")
```

## Dataset Description

The dataset tracks the school's name, district, type (charter or not), student demographics, subject end of year test score averages, ranking in the state, class sizes, average parental education levels, and teacher credentials.

With the test scores as the response, we hope to model how charter schools will perform as compared to public schools using the other fields as predictors.

## Background

School performance as recorded by the CA Dept. of Education from 1999-2013 (https://www.cde.ca.gov/ta/ac/ap/apidatafiles.asp)

## Interest

Interest in this dataset is driven by the current administration's Education Secretary's push to increase the number of charter schools.

## Proof of Loading the Dataset into R
```{r}
library(foreign)
school = read.dbf("data/api10bdb.dbf", as.is = TRUE)
str(school)
```

```{r}
# we only want to look at schools with API and Charter data filled
nrow((school)) 
school = school[which(!is.na(school$CHARTER)),]
nrow(school)
levels(school$CHARTER)

school = school[which(!is.na(school$API10B)),]
nrow(school)  #769

# we want to examine which columns is filled with NA data
# we only want to look at data that is at least half filled
sumval = rep(0, ncol(school))
valcold = rep(FALSE, ncol(school))


for (col in 1:ncol(school)) {
  sumval[col] = sum(!is.na(school[, col]) )
  valcold[col] = as.logical(sumval[col] > nrow(school)/2)
}

valcoln = colnames(school[0,])[valcold]
valcoln

# we only select columns with data filled
school = school[,valcold]

```

```{r}
# Now we eliminate any observations that doesn't have all data filled
# SPED, CHARTER was eliminated
# RTYPE only has 1 level
nrow(school) # 769
ncol(school) # 117
colnames(school[0,])
school = na.omit(school)
(n = nrow(school))  # 144
ncol(school)
colnames(school[0,])


```

```{r}

# convert predictors to factors
# not including API_TARG
fac_pred = c('RTYPE', 'STYPE', 'SPED', 'SIZE', 'CHARTER', "ST_RANK", "SIM_RANK",
             "GR_TARG", "AS_GT", "YR_RND")

# conver predictors to numerics
# could consider adding AA_API etc
num_pred = c("API10B", 
             "PCT_AA", "PCT_AI", "PCT_AS", "PCT_FI", "PCT_HI", "PCT_WH", "PCT_MR",
             "MEALS", "P_GATE",  "P_MIGED", "P_EL", "P_RFEP", "P_DI", "CBMOB", "DMOB", 
             "PCT_RESP", "NOT_HSG", "HSG", "SOME_COL", "COL_GRAD", "GRAD_SCH", "AVG_ED",
             "PEN_2", "PEN_35", "PEN_6", "PEN_78", "PEN_91",
             "ENROLL", "PARENT_OPT", "TESTED", "SCI"
             )
# Only select columns we are interested in
school = subset(school, select = colnames(school[0, ]) %in% c(fac_pred, num_pred))

# convert all columns listed in fac_pred to factors
for(col in fac_pred) {
  if(col %in% colnames(school[0,])) {
    school[, col] = as.factor(school[, col])
  }
}

# convert all columns listed in num_pred to numerics
for(col in num_pred) {
  if(col %in% colnames(school[0,])) {
    school[, col] = as.numeric(school[, col])
  }
}

# split dataframe into training and test
n = nrow(school)
trn_idx = sample(nrow(school), n/2)
school_trn = school[trn_idx, ]
school_tst = school[-trn_idx, ]

```

```{r}

#GR_TARG causing problem when predicting
schl_mod = lm(API10B ~  
                (STYPE + ST_RANK + SIM_RANK + #GR_TARG +
                PCT_AA + PCT_AI + PCT_AS + PCT_FI + PCT_HI + PCT_WH + PCT_MR +
                MEALS + P_GATE + P_MIGED + P_EL + P_RFEP + P_DI +
                CBMOB + DMOB + PCT_RESP + NOT_HSG + HSG + SOME_COL + COL_GRAD + GRAD_SCH +
                AVG_ED + PEN_2 + PEN_35 + PEN_6 + PEN_78 + PEN_91 +
                ENROLL + PARENT_OPT + TESTED + YR_RND + SCI) ,#^ 2,
              data = school_trn)

pred_api = predict(schl_mod, newdata = school_tst)
plot(pred_api ~ school_tst$API10B)

# test assumptions
library(lmtest)
library(faraway)
vif(schl_mod)

summary(schl_mod)
bptest(schl_mod)
nrow(school_trn)
shapiro.test(resid(schl_mod))
plot(fitted(schl_mod) ~ resid(schl_mod), data = school_tst)
qqnorm(resid(schl_mod))
qqline(resid(schl_mod))
```

```{r}
schl_aic = step(schl_mod, direction = "backward", trace = FALSE)
summary(schl_aic)
library(faraway)
vif(schl_aic)
bptest(schl_aic)
nrow(schl_aic)
shapiro.test(resid(schl_aic))
plot(fitted(schl_aic) ~ resid(schl_aic), data = school_tst)
qqnorm(resid(schl_aic))
qqline(resid(schl_aic))


```

### Methodology

- Split data into charter and non-charter.
- Fit models with performance as a response for both.
- Check normality assumptions.
- Responses: english score, math score, science score, exit exam score, state rank
- Factors: parental education, class size, teacher with full credentials, teacher with emergency credentials, student race, district, county
- Study should answer which factors are most relevant to performance, and the differences in those factors between charter schools and public schools
- Plot a longtitude study of how these factors affect the response change over time

```{r}

```

